
# Modify the line below to reflect the location where
# you want to install the library

PREFIX=

# Set WIN32 on the line below to 'TRUE' if building on Windows, otherwise
# set it to 'FALSE'
export WIN32=FALSE
  
# List of all modules to compile
# You can remove "dom" if you don't intend to use the DOM interface
MODULES=unicode input_sources sax dom

##############################
##  Main Makefile: three targets are available:
##    obj:   build all objects (no executable)
##    test:  build the test programs found in the modules
##    clean: remove all object files and temporary files
##    install: install all the files under the PREFIX hierarchy, as
##           defined in Makefile.module
##############################

MODULE_OBJ=${MODULES:%=-aO%/obj}
MODULE_SRC=${MODULES:%=-aI%}
MODULE_CLEAN=${MODULES:%=%_clean}
MODULE_TEST=${MODULES:%=%_test}

RANLIB= @RANLIB@
CHMOD=chmod
ARFLAGS=cr
CP=cp -p -f
MKDIR=mkdir -p

.PHONY: all obj test clean install

all: obj test docs
obj: ${MODULES}

docs: force
	${MAKE} -e -C docs

${MODULES}: force
	${MAKE} -e -C $@ all_obj

${MODULE_CLEAN}: force
	${MAKE} -e -C ${@:%_clean=%} clean

${MODULE_TEST}: force
	${MAKE} -e -C ${@:%_test=%} test

${MODULE_INSTALL}: force
	${MAKE} -e -C ${@:%_install=%} install

install: ${MODULES}
	@${MKDIR} ${PREFIX}/lib
	@${MKDIR} ${PREFIX}/include/xmlada
	# Building the libraries
	${AR} ${ARFLAGS} ${PREFIX}/lib/libxmlada.a ${MODULES:%=%/obj/*.o}
ifeq (${WIN32}, TRUE)
	${RANLIB} ${PREFIX}/lib/libxmlada.a;
else
	@if [ -f /usr/bin/$(RANLIB) -o -f /bin/$(RANLIB) ]; then \
	  ${RANLIB} ${PREFIX}/lib/libxmlada.a; \
        fi
	gcc -shared -o ${PREFIX}/lib/libxmlada.so ${MODULES:%=%/obj/*.o}
endif
	# Installing the files
	${CP} ${MODULES:%=%/obj/*.ali} ${PREFIX}/lib/
	cd ${PREFIX}/lib; ${CHMOD} -w *.ali
	${CP} ${MODULES:%=%/*.ad[bs]} ${PREFIX}/include/xmlada/

test: force
	${MAKE} -e ${MODULE_TEST}

clean: force
	-${RM} *.o
	-${RM} *.ali
	-${RM} textxml
	-${RM} b~*
	${MAKE} -e ${MODULE_CLEAN}
	cd docs; ${MAKE} -e clean

force:
