# Replace with the location for the installation directory
PREFIX=@EXEC_PREFIX@

## The type of library we want to build
LIBRARY_TYPE=relocatable
# LIBRARY_TYPE=static

GNATMAKE=gnatmake
CC=gcc

# Compiler mode: one of "distrib", "debug", "optimize", "profile"
MODE=distrib

CHMOD=chmod
CP=cp -p -f
MKDIR=mkdir -p
LN=ln -f -s

GTKADA_GPR=@GTKADA_GPR@

#########################################################################
## Nothing to modify below this point
#########################################################################

MODULES=unicode input_sources sax dom

ifneq (${GTKADA_GPR},)
MODULES:=${MODULES} xml_gtk
endif

MODULE_INSTALL=${MODULES:%=%_inst}

.PHONY: all obj clean install install_dirs

all: obj docs 

obj: force
	${GNATMAKE} -Punicode/unicode.gpr -XMODE=${MODE} -XLIBRARY_TYPE=${LIBRARY_TYPE}
	${GNATMAKE} -Pinput_sources/input_sources.gpr -XMODE=${MODE} -XLIBRARY_TYPE=${LIBRARY_TYPE}
	${GNATMAKE} -Psax/sax.gpr -XMODE=${MODE} -XLIBRARY_TYPE=${LIBRARY_TYPE}
	${GNATMAKE} -Pdom/dom.gpr -XMODE=${MODE} -XLIBRARY_TYPE=${LIBRARY_TYPE}
ifneq (${GTKADA_GPR},)
	${GNATMAKE} -Pxml_gtk/xml_gtk.gpr -XMODE=${MODE} -XLIBRARY_TYPE=${LIBRARY_TYPE}
endif
 
test: force
	${GNATMAKE} -Punicode/test/unicode_test.gpr -XMODE=${MODE}
	${GNATMAKE} -Psax/test/sax_test.gpr -XMODE=${MODE}
	${GNATMAKE} -Pdom/test/dom_test.gpr -XMODE=${MODE}
ifneq (${GTKADA_GPR},)
	${MAKE} -C xml_gtk/test MODE=${MODE}
endif

docs: force
	${MAKE} -e -C docs

# Rule for installing the modules
%_inst: force
	@${MKDIR}                ${PREFIX}/include/xmlada
	${CP} $*/*.ad[bs]        ${PREFIX}/include/xmlada
	${CP} $*/lib/*.ali       ${PREFIX}/include/xmlada/obj
	${CP} $*/lib/libxmlada_* ${PREFIX}/include/xmlada/obj
	${foreach lib, ${notdir ${wildcard $*/lib/libxmlada_*}}, ${LN} ../include/xmlada/obj/${lib} ${PREFIX}/lib;}
	cd ${PREFIX}/include/xmlada/obj; ${CHMOD} -w *.ali
	cd $*; ls *.ad[bs] > ${PREFIX}/xmlada_$*.lgpr

install_dirs: force
	@${MKDIR} ${PREFIX}/bin
	@${MKDIR} ${PREFIX}/lib
	@${MKDIR} ${PREFIX}/doc/xmlada
	@${MKDIR} ${PREFIX}/include/xmlada
	@${MKDIR} ${PREFIX}/include/xmlada/obj

install: obj docs install_dirs ${MODULE_INSTALL}
	${CP} distrib/${LIBRARY_TYPE}/*.gpr ${PREFIX}
	${CP} xmlada-config ${PREFIX}/bin
	-${CP} docs/xml.ps ${PREFIX}/doc/xmlada
	-${CP} docs/xml.html ${PREFIX}/doc/xmlada
	-${CP} docs/xml.info ${PREFIX}/doc/xmlada
	${CHMOD} +x ${PREFIX}/bin/xmlada-config
ifeq (${GTKADA_GPR},)
	cp distrib/xmlada_gtk_no_module.gpr ${PREFIX}/xmlada_gtk.gpr
endif

clean: force
	gnat clean -q -r -Punicode/unicode.gpr
	gnat clean -q -r -Pinput_sources/input_sources.gpr
	gnat clean -q -r -Psax/sax.gpr
	gnat clean -q -r -Pdom/dom.gpr
	gnat clean -q -r -Pxml_gtk/xml_gtk.gpr
	gnat clean -q -Punicode/test/unicode_test.gpr
	gnat clean -q -Pdom/test/dom_test.gpr
	gnat clean -q -Psax/test/sax_test.gpr
ifneq (${GTKADA_GPR},)
	gnat clean -q -Pxml_gtk/test/xml_gtk_test.gpr
endif
	cd docs; ${MAKE} -e clean

distclean: clean
	${RM} dom/test/default.gpr
	${RM} Makefile config.cache config.log config.status Makefile.314

force:
