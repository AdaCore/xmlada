# Replace with the location for the installation directory
PREFIX=@EXEC_PREFIX@

GNATMAKE=gnatmake
CC=gcc

# Version of the library. This must be synchronized with shared.gpr
MAJOR=1
MINOR=0

# Compiler mode: one of "distrib", "debug", "optimize", "profile"
MODE=distrib

CHMOD=chmod
CP=cp -p -f
MKDIR=mkdir -p
LN=ln -f -s

#########################################################################
## Nothing to modify below this point
#########################################################################

MODULES=unicode input_sources sax dom
MODULE_INSTALL=${MODULES:%=%_inst}

.PHONY: all obj clean install install_dirs

all: obj docs 

obj: force
	${GNATMAKE} -Pbuild_all.gpr -XMODE=${MODE}
 
test: force
	${GNATMAKE} -Punicode/test/unicode_test.gpr -XMODE=debug
	${GNATMAKE} -Psax/test/sax_test.gpr -XMODE=debug
	${GNATMAKE} -Pdom/test/dom_test.gpr -XMODE=debug

docs: force
	${MAKE} -e -C docs

# Rule for installing the modules
%_inst: force
	@${MKDIR}                ${PREFIX}/include/xmlada/$*
	${CP} $*/*.ad[bs]        ${PREFIX}/include/xmlada/$*
	${CP} $*/lib/*.ali       ${PREFIX}/include/xmlada/obj
	${CP} $*/lib/libxmlada_* ${PREFIX}/lib
	cd ${PREFIX}/include/xmlada/obj; ${CHMOD} -w *.ali

install_dirs: force
	@${MKDIR} ${PREFIX}/bin
	@${MKDIR} ${PREFIX}/lib
	@${MKDIR} ${PREFIX}/include/xmlada
	@${MKDIR} ${PREFIX}/include/xmlada/obj

install: obj install_dirs ${MODULE_INSTALL}
	${CP} xmlada-config ${PREFIX}/bin
	${CP} xmlada.gpr ${PREFIX}
	${CP} xmlada_unicode.gpr ${PREFIX}
	${CP} xmlada_dom.gpr ${PREFIX}
	${CP} xmlada_input.gpr ${PREFIX}
	${CP} xmlada_sax.gpr ${PREFIX}
	${CHMOD} +x ${PREFIX}/bin/xmlada-config

clean: force
	gnat clean -r -Pbuild_all.gpr
	gnat clean -Pdom/test/dom_test.gpr
	gnat clean -Psax/test/sax_test.gpr
	cd docs; ${MAKE} -e clean

distclean: clean
	${RM} dom/test/default.gpr
	${RM} Makefile config.cache config.log config.status Makefile.314

force:
